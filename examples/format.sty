\input btxmac
\input idxmac.tex
%\input verbatim.tex

%%
%% Defining new cwebmac.tex macros
%%

%defining how to output terminals and nonterminals
\def\ts#1{{\sc #1}}
\def\nts#1{{\sl #1\/}}
% redefining the box around verbatim code
\def\vb#1{\hbox{\strut\.{#1}}}
% regular expressions and actions
\newbox\rebox
\def\re#1{\leavevmode\setbox\rebox\hbox{#1\hfill}\ifdim\wd\rebox<7em\wd\rebox=7em\fi\box\rebox\quad}
\def\ac{\global\ind=10\hangindent=\ind em\relax}
\def\eac{\global\ind=3\hangindent=\ind em\relax}
% yskip is usually a smallskip = 3pt pus 1pt minus 1pt
% I give it some extra stretchability
%\def\yskip{\vskip 3pt plus 3pt minus 1pt}
\let\yskip\smallbreak


% redefine \5 for an optional break without the 2.5em reduced indentation
%\def\5{\hskip 0pt plus 2.5em\penalty-1\hskip 0pt plus -2.5em\kern0.5em\ignorespaces}% optional break
%redefine \5 to give some shrinkability
\def\5{\hfil\penalty10\hfilneg\hskip 0pt minus 6pt\kern2.5em\copy\bakk\ignorespaces}% optional break
\def\J{}% dont show @& in the tex output
\def\Y{\par\yskip}

% macro to include images

%\ifx\pdfliteral\undefined %  postscript und ps2pdf
%  \input epsf.tex
%  \def\includefig#1{\epsfbox{image/#1.eps}}% this is a \leavevmode\hbox{...}
%\else
%  \def\includefig#1{\leavevmode\hbox{\immediate\pdfximage{image/#1.pdf}\pdfrefximage\pdflastximage}}
%\fi

\def\hair{\kern.05em\relax} % teeny tiny space



\font\tenss=cmss10 % used for the HINT name

\def\ts#1{\leavevmode\hbox{\sc#1}} % smallcaps for terminal symbols

%\font\tenssbx=cmssbx10 % used for the HINT name

%\def\Pascal/{{\mc P\kern-.05emascal\spacefactor1000}}
\def\Pascal/{\leavevmode\hbox{\mc P\kern-.05emascal}}
\def\WEB/{\leavevmode\hbox{\tt WEB\spacefactor1000}}
\def\HINT/{\leavevmode\hbox{\tenss HINT\spacefactor1000}}
\def\cweb/{\leavevmode\hbox{\tt cweb}}
\def\web2w/{\leavevmode\hbox{\tt web2w}}
\def\LaTeX{L\kern-.36em\raise.3ex\hbox{\sc A}\kern-.15em\TeX}%

% for the index
\def\see#1#2{\hskip 0pt plus 100pt\penalty 0\hskip 0 pt plus -100pt{\it see\/} #1}


% special treatment for @
\def\makeatletter{\catcode`\@=11\relax}
\def\makeatother{\catcode`\@=12\relax}
\makeatletter

%% special controlsequences %%

\def\abs#1{\left|#1\right|}

%%
%% Special commands to achive the desired layout
%%


% the other variables are defined in cwebmac.tex
\newdimen\headheight 
\newdimen\footheight 
\newdimen\leftmargin
\newdimen\rightmargin
\newdimen\topmargin
\newdimen\bottommargin
\newdimen\marginwidth

\leftmargin=22mm
\rightmargin=22mm
\topmargin=15mm
\bottommargin=27mm
\marginwidth=0pt % we do not have notes in the margin

\headheight=12pt % Text in Head
\advance\headheight+13pt % Abstand 1pt, Linie 0.47pt und Abstand zum Text 11.53pt
\footheight=0pt % Text in Footer

\pagewidth=6.69in
\advance\pagewidth-\leftmargin % left margin/offset
\advance\pagewidth-\rightmargin % left margin/offset

\fullpageheight=9.61in
\advance\fullpageheight-\topmargin% topmargin
\advance\fullpageheight-\bottommargin% bottommargin

\pageheight=\fullpageheight
\advance\pageheight-\headheight
\advance\pageheight-\footheight

\def\setpage{\hsize\pagewidth\advance\hsize-\marginwidth\vsize\pageheight} % use after changing page size

\setpage

% setting the papersize for postscript and pdf

\ifx\pdfliteral\undefined %  postscript und ps2pdf
   \special{papersize=6.69in,9.61in}
\else % pdftex
  \pdfpageheight=9.61in
  \pdfpagewidth=6.69in
  \pdfhorigin=\leftmargin
  \pdfvorigin=\topmargin
  \pdfcompresslevel=9
  \pdfdecimaldigits=4
  \pdfpkresolution=1200
  \pdfimageresolution=1200
\fi

\ifx\book\undefined
\def\pdflinkcolor{0 0 1} % the RGB values for hyperlink color
\def\linkcolor{\Blue}
\else
\def\pdflinkcolor{0 0 0} % the RGB values for hyperlink color
\def\linkcolor{\Black}
\fi

\ifpdftex
  \ifx\pdfannotlink\undefined\let\pdfannotlink\pdfstartlink\fi% for pdfTeX 0.14
  \def\pdflink#1#2{\hbox{\pdfannotlink height\ht\strutbox depth\dp\strutbox
    attr{/Border [0 0 0]} goto num #1 \linkcolor #1\Black\pdfendlink}}
\else\def\pdflink#1#2{\setbox0=\hbox{\special{pdf: bc [ \pdflinkcolor ]}{#1}%
    \special{pdf: ec}}\special{pdf: ann width \thewidth height \theheight
      depth \thedepth << /Type /Annot /Subtype /Link
      /Border [0 0 0] /A << /S /GoTo /D (#2) >> >>}\box0\relax}\fi



\newskip\abovesecskip 
\newskip\belowsecskip 
\newskip\abovesubsecskip
\newskip\belowsubsecskip 

%\abovesecskip= 6ex plus 1ex minus .2ex %space above the section
%\belowsecskip=3.7ex plus .2ex% space after section
\abovesecskip= 0.15\vsize plus 5ex minus 1ex %space above the section
\belowsecskip=10pt plus 2pt% space after section
\abovesubsecskip=9pt plus 4pt minus 2pt%space above the section
\belowsubsecskip=3pt plus 1pt minus 0.5pt% space after section

\parskip 0pt plus .8pt


%% Table of Figures Tables and Equations
\def\@wrfigindex#1#2#3#4{%
   \xdef\gtempa{\write#1{\string\indexentry{#2}{#3}{#4}{\noexpand\thepageno}}}\endgroup\gtempa
   \if@nobreak\ifvmode\@nobreak\fi\fi\@esphack}
\def\@wrcodeindex#1#2#3#4{%
   \xdef\gtempa{\write#1{\string\indexentry{#3}{#2}{\noexpand\thepageno}{#4}}}\endgroup\gtempa\@esphack}


%   \if@nobreak\ifvmode\@nobreak\fi\fi

\newwrite\@figfile
\newwrite\@tabfile
\newwrite\@getfile
\newwrite\@putfile
\newwrite\@redfile
\newwrite\@wrtfile


\def\makefigindex{%
  \immediate\openout\@figfile=\jobname.fig\relax
  \def\figindex{\@bsphack\begingroup\@sanitize\@wrfigindex\@figfile}%
  \immediate\openout\@tabfile=\jobname.tab\relax
  \def\tabindex{\@bsphack\begingroup\@sanitize\@wrfigindex\@tabfile}%
}


\def\makecodeindex{%
\makeatletter
}


\newdimen\iboxsize
\def\subindex#1{%
  \par\ifhmode\unskip\fi%     end paragraph and remove vertical space
  \vskip\abovesubsecskip%   space above the subsection
  \vskip 0pt plus 72pt% allow some empty space at the bottom
  \penalty-200\vskip 0pt plus -72pt %    room for stetching and a page break
  \noindent{\bf\strut#1}
  %\gdef\subsectionname{\thesection.\the\subsectioncount\quad#1}%
  %\mark{{\sectionname}{\subsectionname}}%
  \nobreak\vskip\belowsubsecskip% space after subsection
  \everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
  \ignorespaces
}

\def\thefigindex{%
\def\indexentry##1##2##3##4{\noindent
  \line{\hbox to \iboxsize{%
    \rm##1.\hfil##2:~}{\rm ##3}\ \leaders\hbox to .5em{.\hfil}\hfill\hbox to 1.4em{\hss##4}}\par
}%
  \immediate\closeout\@figfile\relax
  \immediate\closeout\@tabfile\relax
%\small\baselineskip=11pt
\plainsection{List of Figures and Tables}
  \iboxsize=3.7em\relax
  \subindex{Figures}
  \input\jobname.fig\relax
  \iboxsize=3.9em\relax
  \subindex{Tables}
  \input\jobname.tab\relax
}

\newbox\codebox
\def\makecode{%

\immediate\openout\@getfile=\jobname.get\relax
\immediate\openout\@putfile=\jobname.put\relax
\immediate\openout\@redfile=\jobname.red\relax
\immediate\openout\@wrtfile=\jobname.wrt\relax
\typeout{Writing index files \jobname.fig \jobname.tab \jobname.get \jobname.put \jobname.red \jobname.wrt}
}




\def\thecodeindex{%
\immediate\closeout\@getfile\relax
\immediate\closeout\@putfile\relax
\immediate\closeout\@redfile\relax
\immediate\closeout\@wrtfile\relax
\def\indexentry##1##2##3##4{
  \ifnum##2=0 \smallskip\vskip 0pt plus 12pt\penalty -100\vskip 0pt plus -12pt\fi
  \noindent
  \line{%
     \ifnum##2=0##4\hfill
     \else\qquad\rm##4\ \leaders\hbox to .5em{.\hfil}\hfill\hbox to 1.4em{\hss##3}\fi
  }\par
}%
\section{List of Format Definitions}

\makeatletter
  \subsection{Reading the Long Format}\label{codeindex}
  \input\jobname.red.srt\relax
  \subsection{Writing the Long Format}
  \input\jobname.wrt.srt\relax
  \subsection{Reading the Short Format}
  \input\jobname.get.srt\relax
  \subsection{Writing the Short Format}
  \input\jobname.put.srt\relax
}

%% Makeindex

% new jobname for index file
\def\makeindex{\if@filesw \newwrite\@indexfile
  \immediate\openout\@indexfile=\jobname.inx%
  \def\index{%\hbox to 0pt{\hss$\bullet$}%
  \@bsphack\begingroup\@sanitize\@wrindex\@indexfile}%
  \typeout{Writing index file \jobname.inx }\fi
}

\def\@wrindex#1#2{%
   \xdef\gtempa{\write#1{\string
      \indexentry{#2}{\noexpand\thepageno}}}\endgroup\gtempa
   \if@nobreak \ifvmode\@nobreak\fi\fi\@esphack}

\def\@esphack{\relax\ifhmode\spacefactor\@savsf
     {}\ifdim \@savsk >\z@ \ignorespaces 
  \fi \fi}

\def\@idxitem{\par\hangindent 40pt}
 
\newif\ifnextindex
\nextindexfalse

\def\beginindex{%
  \def\page{\box255 } \normalbottom
  \output{\ifpagesaved\normaloutput{\box\sbox}\lheader\rheader\fi
    \global\setbox\sbox=\page \global\pagesavedtrue}
  \pagesavedfalse \eject % eject the page-so-far and predecessors
  \setbox\sbox\vbox{\unvbox\sbox} % take it out of its box
  \vsize=\pageheight \advance\vsize by -\ht\sbox % the remaining height
  \hsize=.5\pagewidth \advance\hsize by -10pt
    % column width for the index (20pt between cols)
  \parfillskip 0pt plus .6\hsize % try to avoid almost empty lines
  \def\lr{L} % this tells whether the left or right column is next
  \output{\if L\lr\global\setbox\lbox=\page \gdef\lr{R}
    \else\nomarginoutput{\vbox to\pageheight{\box\sbox\vss
        \hbox to\pagewidth{\box\lbox\hfil\page}}}\lheader\rheader
    \global\nextindextrue
    \global\vsize\pageheight\gdef\lr{L}\global\pagesavedfalse\fi}
  \message{Index:}
\mark{{0}{0}}
\begingroup
  \rightskip 0pt plus 6pt
  \parskip 0pt plus .5pt
  \hyphenpenalty 10000 \parindent0pt
  \small\baselineskip=11pt
\def\item{\par\hangindent 40pt\relax\ifnextindex\mark{{Index}{Index}}\fi}%
\def\subitem{\par\hangindent 40pt\hskip 20pt\relax}%
\def\subsubitem{\par\hangindent 40pt\hskip 30pt\relax}%
\def\indexspace{\par\vskip 12pt plus 6pt minus 4pt\vskip 12pt\goodbreak\vskip -12pt\relax}%
\def\indexheading##1{{\tenbf ##1\nobreak\vskip 3pt\relax}}
}
\def\endindex{%
\endgroup
  \vfill\eject % complete the current column.
  \if R\lr\null\vfill\eject\fi % if necessarry add a right column
}

\def\title{web2w}

\newcount\enum
\def\enumerate{\par\bgroup\advance\leftskip by\parindent\enum=0%
   \def\item{\advance\enum by 1\par\smallskip\noindent\hbox to 0pt{\hss\the\enum.~}\ignorespaces}}
\def\endenumerate{\medskip\egroup\noindent}


\def\itemize{\par\bgroup\advance\leftskip by\parindent\relax%
   \def\item{\par\smallskip\noindent\llap{$\bullet$\enspace}\ignorespaces}}
\def\enditemize{\medskip\egroup\noindent}

%% Large Font for sections
%\font\largebf=cmb14 scaled\magstep0
%\font\largebf=cmb12 scaled\magstep1
\font\largebf=cmbx12 scaled\magstep1
%\font\largebf=cmbx8 scaled\magstep3

%\font\largeit=cmti14 scaled\magstep0
\font\largeit=cmti12 scaled\magstep1

%\font\largett=cmtt14 scaled\magstep0
\font\largett=cmtt12 scaled\magstep1

%\font\largerm=cmr14 scaled\magstep0
\font\largerm=cmr12 scaled\magstep1


% for mathbolditalic
%\font\tenmib=cmmib10 scaled\magstep0
\font\tenmib=cmmib10 scaled\magstep0
\font\largemib=cmmib10 scaled\magstep1


%% Small Fonts for Figure and Table descriptions
\font\figbf=cmbx9 scaled\magstep0
\font\figit=cmti9 scaled\magstep0
\font\figmit=cmmi9 scaled\magstep0
\font\figsy=cmsy9 scaled\magstep0
\font\figtt=cmtt9 scaled\magstep0
\font\figrm=cmr9 scaled\magstep0
% for mathbolditalic
\font\figmib=cmmib9 scaled\magstep0



\def\large{\def\rm{\fam0\largerm}\let\bf\largebf\let\it\largeit\let\tt\largett\let\mib\largemib%
\textfont0=\largerm\textfont1=\largeit
\setbox\strutbox=\hbox{\vrule height9.5pt depth5.0pt width\z@}\rm}

\def\small{\def\rm{\fam0\figrm}\let\bf\figbf\let\it\figit\let\tt\figtt\let\mib\figmib%
\textfont0=\figrm\textfont1=\figmit\textfont2=\figsy%
\setbox\strutbox=\hbox{\vrule height9.0pt depth4.5pt width\z@}\rm}


\let\tiny\eightrm
\let\mib\tenmib

\def\.#1{\leavevmode\hbox{\tt % typewriter type for strings
  \let\\=\BS % backslash in a string
  \let\{=\LB % left brace in a string
  \let\}=\RB % right brace in a string
  \let\~=\TL % tilde in a string
  \let\ =\SP % space in a string
  \let\_=\UL % underline in a string
  \let\&=\AM % ampersand in a string
  \let\^=\CF % circumflex in a string
  \let\|=\VB % vertical bar in a string
  #1\kern.05em}}

\chardef\VB=`\| % vertical bar character in a string
%from webmac.tex
\def\^{\ifmmode\mathchar"222 \else\char`^ \fi} % pointer or hat

\newcount\sectioncount
\sectioncount=0
\newcount\subsectioncount
\subsectioncount=0
\newcount\subsubsectioncount
\subsubsectioncount=0
\newcount\codecount
\codecount=0


%% Sections
\newif\ifappendix
\appendixfalse

\mark{{0}{0}}\vskip 0pt minus 100pt
%\hbox{Mark empty empty}%
\def\thesection{\the\sectioncount}

\def\sectionbox#1{\hskip-\marginwidth\hbox to \marginwidth{#1\hfil}}

\def\heading#1#2{%
\def\secno{{\noindent\large\bf\strut\sectionbox{#1}#2}}%
\par\ifhmode\unskip\fi%     end paragraph and remove vertical space
\vskip 0pt plus 72pt%allow some empty space at the bottom
\penalty-500
\vskip 0pt plus -72pt%    room for stetching and a page break
\hbox{}\vskip\abovesecskip%   space above the section
%%\titletrue % omits page header for section
%\hbox{Mark null null}%
\mark{{0}{0}}%
\secno% The section title
\mark{{\sectionname}{\sectionname}}%
\nobreak\vskip\belowsecskip% space after section
\everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
\ignorespaces}




\def\plainsection#1{%
\mark{{\sectionname}{\subsectionname}}%
%\hbox{Mark {\sectionname}{\subsectionname}}%
\sectionpage{#1}%
\gdef\sectionname{#1}%
\gdef\subsectionname{#1}%
\gdef\codetitle{#1}%
\gdef\subcodetitle{#1}%
\heading{}{#1}%
\tocsection{}{#1}
}

\def\tocsection#1#2{%
\edef\next{\write\cont{\tocline {0}{#1}{#2}% write to contents file
                     {\noexpand\thepageno}}}\next % \tocline{depth}{sec}{title}{page}
}

\gdef\sectionname{}
\gdef\subsectionname{}
\gdef\codetitle{}%
\gdef\subcodetitle{}

\def\sectionpage#1{%
\vfil\break
\ifodd\pageno\else
\hbox{}%
\titletrue
\fi
\vfil\break
}



\def\section#1{%
\mark{{\sectionname}{\subsectionname}}%
\subsectioncount=0\advance\sectioncount by 1\relax%updating counts
\sectionpage{\thesection\quad#1}%
\gdef\sectionname{\thesection\quad#1}%
\gdef\subsectionname{\thesection\quad#1}%
\gdef\codetitle{#1}%
\gdef\subcodetitle{#1}%
\ifnum\sectioncount=1\ifappendix\heading{}{Appendix}\tocsection{}{Appendix}\fi\fi
\heading{\thesection~}{#1}%
\tocsection{\thesection}{#1}%
}


\def\subsection#1{%
\def\secno{{\noindent\bf\strut\sectionbox{\thesection.\the\subsectioncount~}#1}}%
\par\ifhmode\unskip\fi%     end paragraph and remove vertical space
\vskip 0pt plus 36pt% allow some empty space at the bottom
\penalty-100\vskip 0pt plus -36pt%    room for stetching and a page break
\subsubsectioncount=0\advance\subsectioncount by 1%updating counts
\gdef\subsectionname{\thesection.\the\subsectioncount\quad#1}%
\mark{{\sectionname}{\subsectionname}}%
\vskip\abovesubsecskip%   space above the subsection
\edef\next{\write\cont{\tocline {1}{\thesection.\the\subsectioncount}{#1}
{\noexpand\thepageno}}}\next % \tocline{depth}{sec}{title}{page}%
\secno% The subsection title
\gdef\subcodetitle{#1}%
%\mark{{\sectionname}{\subsectionname}}%
%\hbox{Mark {\sectionname}{\subsectionname}}%
\nobreak\vskip\belowsubsecskip% space after subsection
\everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
\ignorespaces}



\def\hascode{\advance\codecount by 1%
\codelabel{0}{\the\codecount}{\codetitle}}%

\def\getindex{\@bsphack\begingroup\@sanitize\@wrcodeindex\@getfile}%
\def\putindex{\@bsphack\begingroup\@sanitize\@wrcodeindex\@putfile}%
\def\redindex{\@bsphack\begingroup\@sanitize\@wrcodeindex\@redfile}%
\def\wrtindex{\@bsphack\begingroup\@sanitize\@wrcodeindex\@wrtfile}%

\def\codelabel#1#2#3{
\getindex{#1}{#2}{#3}%
\putindex{#1}{#2}{#3}%
\redindex{#1}{#2}{#3}%
\wrtindex{#1}{#2}{#3}}
\def\getsymbol{$\cdots\Longrightarrow$}
\def\putsymbol{$\Longrightarrow\cdots$}
\def\redsymbol{$-{}-{}-{}\Longrightarrow$}
\def\wrtsymbol{$\Longrightarrow{}-{}-{}-$}
\def\getcode{\codesection{\getsymbol}{Reading the short format}\getindex{1}{\the\codecount}{\subcodetitle}}
\def\putcode{\codesection{\putsymbol}{Writing the short format}\putindex{1}{\the\codecount}{\subcodetitle}}
\def\writecode{\codesection{\wrtsymbol}{Writing the long format}\wrtindex{1}{\the\codecount}{\subcodetitle}}
\def\readcode{\codesection{\redsymbol}{Reading the long format}\redindex{1}{\the\codecount}{\subcodetitle}}
\newdimen\coderule
\def\codesection#1#2{%
  \par\ifhmode\unskip\fi%     end paragraph and remove vertical space
  \vskip 0pt plus 72pt% allow some empty space at the bottom
  \penalty-200\vskip 0pt plus -72pt%    room for stetching and a page break
\vskip\abovesubsecskip%   space above the subsection
%\line{\setbox0=\hbox{#1}%
%\coderule=\hsize\advance\coderule by -\wd0\advance\coderule by -2em%
%$\vcenter{\hrule width \coderule}$\hss\box0}
\line{{\it #2\/}:\hfill#1}
\nobreak\vskip\belowsubsecskip\nobreak% space after subsection
%\everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
%\noindent
\ignorespaces}

\def\subsubsection#1{%
%\mark{{\sectionname}{\subsectionname}}%
%\hbox{Mark {\sectionname}{\subsectionname}}%
\advance\subsubsectioncount by 1%updating counts
\def\secno{{\noindent\it\strut\sectionbox{\thesection.\the\subsectioncount.\the\subsubsectioncount~}#1}}%
\par\ifhmode\unskip\fi%     end paragraph and remove vertical space
\vskip 0pt plus 36pt% allow some empty space at the bottom
\penalty-100\vskip 0pt plus -36pt%    room for stetching and a page break
\vskip\abovesubsecskip%   space above the subsection
\edef\next{\write\cont{\tocline {2}{\thesection.\the\subsectioncount.\the\subsubsectioncount}{#1}
{\noexpand\thepageno}}}\next % \tocline{depth}{sec}{title}{page}%
\secno% The subsubsection title
%\gdef\subsectionname{\thesection.\the\subsectioncount\quad#1}%
%\mark{{\sectionname}{\subsectionname}}%
%\hbox{Mark {\sectionname}{\subsectionname}}%
\nobreak\vskip\belowsubsecskip% space after subsection
%\everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
%\noindent
\ignorespaces}


\def\Alphanum#1{%
  \ifcase#1\or A\or B\or C\or D\or E\or F\or G\or H\or I\or J\or
   K\or L\or M\or N\or O\or P\or Q\or R\or S\or T\or U\or V\or W\or X\or
    Y\or Z\else\number#1\fi}

\def\appendix{%
\sectioncount=0
\subsectioncount=0
\gdef\thesection{\Alphanum\sectioncount}%
\appendixtrue
}

%% frontmatter and mainmatter
\def\frontmatter{\pageno=4\def\thepageno{\romannumeral\pageno}}
\def\mainmatter{
\mark{{\sectionname}{\subsectionname}}
%\hbox{Mark {\sectionname}{\subsectionname}}
\vfil\break\ifodd\pageno\pageno=1\else\pageno=0\fi
\def\thepageno{\the\pageno}%
\sectioncount=0
\mark{{}{}}%
%\hbox{Mark empty empty}%
\gdef\sectionname{}
\gdef\subsectionname{}
\gdef\codetitle{}
\gdef\subcodetitle{}
}



%% Quotations (form the standard)

\def\beginquote{\bgroup\narrower\noindent\sl}
\def\endquote{\egroup}

%% Table of Content


\newbox\tocbox
\def\maketoc{%
  \setbox\tocbox\vbox{%\startpdf
  \input\jobname.toc\relax
}}

\def\tableofcontent{\plainsection{Contents}%
\unvbox\tocbox
}

% how contentslines look
\def\tocline#1#2#3#4{\ifnum#1=0 \smallskip\vskip 0pt plus 12pt\penalty -100\vskip 0pt plus -12pt\fi
\noindent
\line{\ifnum#1=0         \hbox to 2em{\bf#2\hfill}{\bf#3~}                             \hfill\hbox to 2em{\hss\bf#4}%
\else \ifnum#1=1\kern 2em\hbox to 3em{\rm#2\hfill}{\rm#3~}\leaders\hbox to .5em{.\hfil}\hfill\hbox to 2em{\hss#4}%
\else           \kern 2em\hbox to 5em{\rm#2\hfill}{\it#3~}\leaders\hbox to .5em{.\hfil}\hfill\hbox to 2em{\hss#4}\fi\fi
}}


\def\center#1{\bigskip\line{\hfil#1\hfil}\bigbreak}


%% Figures and Tables
\def\captype{}
\newdimen\capskip
\capskip=1em
\newbox\capbox
\setbox\capbox\hbox{}
\newcount\figcount
\figcount=0
\newcount\tabcount
\tabcount=0
\newcount\cdcount
\cdcount=0



\def\nextcaption#1{\small\strut\it\hskip\capskip\global\advance\figcount by 1\figindex{\captype}{\the\figcount}{#1}\captype.~\the\figcount:}
\def\caption#1{\global\setbox\capbox\hbox{\nextcaption{#1} #1}}

\def\nexttabcaption#1{\small\strut\it\hskip\capskip\global\advance\tabcount by 1\tabindex{\captype}{\the\tabcount}{#1}\captype.~\the\tabcount:}
\def\tabcaption#1{\global\setbox\capbox\hbox{\nexttabcaption{#1} #1}}

\def\fig#1{%
\ifvmode\noindent\fi
\def\captype{Fig}%
\capskip=1em%
\vbox{\nointerlineskip
\hbox{\noindent#1\hskip -2pt\hskip 0pt plus 2pt minus 2pt}%
\medskip
\rlap{\small\unhbox\capbox}%
}}

%\long\def\leftfig#1#2#3{%
%\ifvmode\noindent\fi
%\def\captype{Fig}%
%\capskip=1em%
%\vbox{%
% \tabskip=0pt\halign to \hsize{%
% \vtop{\vskip 0pt\parskip=0pt\hsize=62.5mm\relax
%  ##}\tabskip=5mm plus 2pt minus 2pt&
% \vtop{\vskip 0pt\parskip=0pt\hsize=62.5mm\relax##}\tabskip=0pt\cr
% #1&\capskip=0pt\nextcaption{#2} #3\cr}\medbreak}}

\long\def\leftright#1#2#3#4{%
\ifvmode\noindent\else\par\noindent\fi
\vbox{\nointerlineskip
  \advance\hsize by -\leftskip\advance\hsize by -\rightskip%
  \leftskip=0pt\rightskip=0pt%
  \hbox to \hsize{\strut
   \raise\ht\strutbox
   \vtop{\vskip 0pt\parskip=0pt\hsize=#1\hsize\advance\hsize by -2.5mm\relax
   \noindent\strut\ignorespaces#3\vfill}\hfil
   \raise\ht\strutbox
   \vtop{\vskip 0pt\parskip=0pt\hsize=#2\hsize\advance\hsize by -2.5mm\relax
   \noindent\strut\ignorespaces#4\vfill}}}}


\long\def\leftfig#1#2#3{%
\def\captype{Fig}%
\capskip=0pt%
\leftright{0.5}{0.5}{#1\kern -2pt\hskip 2pt plus 2pt minus 2pt}{\nextcaption{#2}\strut #3}}


\def\tab#1{%
\ifvmode\noindent\fi
\def\captype{Tab}%
\capskip=0pt%
\vbox{#1\medskip\rlap{\small\unhbox\capbox}}}


\def\table#1#2{%
\ifvmode\noindent\fi
\def\captype{Tab}%
\capskip=0pt%
\vbox{\offinterlineskip\halign{\large\strut
   \vrule##&&\quad\hfil##\hfil\quad\vrule\cr
   \noalign{\hrule}#2\noalign{\hrule}}%
   \medskip
   \tabcaption{#1}%
  \rlap{\small\unhbox\capbox}%
  }%
}


\long\def\float#1{\midinsert\parindent 0pt\relax#1\endinsert}

%\def\float#1{\midinsert
%\hsize\pagewidth
%\parindent 0pt\vbox{\hbox{\kern-\marginwidth\vbox{#1}}}\endinsert}



% code boxes
%\def\acodebox{%
%\midinsert
%\vbox\bgroup
%\capskip=2em\def\captype{Fig}%
%\nointerlineskip\hrule
%\hbox to \hsize\bgroup
%\vrule\hskip 6pt plus 1pt minus 1pt\vbox\bgroup
%\advance\hsize by -12.8pt % 0.4pt vrule +6pt magin times 2 
%\medskip\ignorespaces
%}
%\def\endacodebox{
%\smallskip\egroup\hskip 6pt plus 1pt minus 1pt\vrule\egroup
%\hrule\egroup
%\smallskip
%\rlap{\unhbox\capbox}%
%\endinsert
%}
%\def\flushcode{\ifnum\insertpenalties>0\vfill\dosupereject
%\hbox{}\kern-\topskip
%\nobreak\vfill
%\fi
%}

%% Bibtex interface
\def\mbox#1{\leavevmode\hbox{#1}}


%% URLs
{{\gdef\urldot{.}
  \catcode`.=13
  \gdef\urlslash{/}
  \catcode`/=13
  \gdef\urlspecials{\def.{\urldot\penalty 0}\def/{\urlslash\penalty 0\catcode`_=12}
}}}
\def\url{\bgroup\hskip 1cm plus 5cm\penalty -100\hskip -1cm plus -5cm\tt\catcode`\~=12\catcode`.=13\catcode`/=13\urlspecials}
\def\endurl{\egroup}


%% Making references using stuff from btxmac (above)
\newdimen\labelskip
\def\label#1{% writes \labeldef{name}{{page}{section}{subsection}{figure}{table}{code}} to aux
   \begingroup\@readauxfile
   \edef\next{\@writeaux{\string\labeldef{#1}{{\noexpand\thepageno}%
      {\thesection}{\the\subsectioncount}{\the\figcount}{\the\tabcount}{\the\cdcount}{\the\enum}}}\endgroup}%
   \ifvmode %make \removelastskip work after \label 
     \labelskip=\lastskip
     \vskip-\labelskip
     \next
     \vskip\labelskip
   \else
     \next
   \fi
}


\def\m@kelabel#1{label@#1}% this makes the controlseqence from the name

\def\labeldef#1#2{% #1 is name #2 is page section subsection figure table code
\expandafter\gdef\csname\m@kelabel{#1}\endcsname{#2}}%

\def\@setref#1#2#3{%
  \ifx#1\relax
   \message{Undefined reference: #3}
  \else
   \expandafter#2#1\null
  \fi}

\def\@iofvii#1#2#3#4#5#6#7{#1}
\def\@ii@iiiofvii#1#2#3#4#5#6#7{#2\ifnum#3>0\relax.#3\fi}
\def\@ivofvii#1#2#3#4#5#6#7{#4}
\def\@vofvii#1#2#3#4#5#6#7{#5}
\def\@viofvii#1#2#3#4#5#6#7{#6}
\def\@viiofvii#1#2#3#4#5#6#7{#7}

\def\pageref#1{\@readauxfile
\expandafter\@setref\csname\m@kelabel{#1}\endcsname\@iofvii{#1}}
\def\secref#1{\@readauxfile
\expandafter\@setref\csname\m@kelabel{#1}\endcsname\@ii@iiiofvii{#1}}
\def\figref#1{\@readauxfile
\expandafter\@setref\csname\m@kelabel{#1}\endcsname\@ivofvii{#1}}
\def\tabref#1{\@readauxfile
\expandafter\@setref\csname\m@kelabel{#1}\endcsname\@vofvii{#1}}
\def\cdref#1{\@readauxfile
\expandafter\@setref\csname\m@kelabel{#1}\endcsname\@viofvii{#1}}
\def\enumref#1{\@readauxfile
\expandafter\@setref\csname\m@kelabel{#1}\endcsname\@viiofvii{#1}}




%%
%% Redefining cwebmac.tex macros
%%

% the box for the points to operator "->" in C 
\setbox\MGbox=\hbox{$\rightarrow$}

% how to display NULL
\def\NULL{\tt NULL}

\def\note#1#2.{}
%\Y\noindent{\hfill%
%    \baselineskip10pt\tiny#1~\ifacro{\pdfnote#2.}\else#2\fi.\par}}

% start sections
\def\stsec{\rightskip=0pt % get out of C mode (cf. \B)
  \sfcode`;=1500 \pretolerance 200 \hyphenpenalty 50 \exhyphenpenalty 50 %
  \ifpdftex
     {\let\*=\empty\pdfdest num \secstar fith}%
  \else
    \ifpdf
      {\let\*=\empty\special{pdf: dest (\romannumeral\secstar) [ @thispage /FitH @ypos ]}}%
    \fi
  \fi
}

{\rm\gdef\strutdepth{\dp\strutbox}}
\def\B{\rightskip=0pt plus 100pt minus 0pt % go into C mode
  \sfcode`;=3000
  \pretolerance 10000
  \hyphenpenalty 1000 % so strings can be broken (discretionary \ is inserted)
  \exhyphenpenalty 1000
  \global\ind=2 \1\ \unskip\vadjust{\vtop to 0pt{\vss\hbox to \hsize{\hfill\tiny(\thecode)}\kern 0pt}}}

% formating of C comments
\def\C#1{\5\hfill$/\ast\,${\cmntfont #1}$\,\ast/$}

% section begin
\def\M#1{\MN{#1}\ifon\stsec\smallskip
%\everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
\noindent\ignorespaces}% beginning of section

\def\N#1{\MN{#1}\ifon\stsec\smallskip
%\everypar{{\setbox0=\lastbox}\everypar{}}% no indentation in the next paragraph
\noindent\ignorespaces}% beginning of section

\def\MN#1{\smallskip
 {\xdef\secstar{#1}\let\*=\empty\xdef\secno{#1}}%
  \gdef\thecode{#1}% common code for \M, \N
  \ontrue}

% Used in section text
\def\U{\rightnote{Used in}} % xref for use of a section
\def\Us{\rightnote{Used in}} % xref for uses of a section
% replacing \note in \U and \Us by \rightnote 
%\def\rightnote#1#2.{\vskip-\baselineskip\vtop to 0pt{\vss\hbox to \hsize{\hfill
%    \tiny#1~\ifacro{\pdfnote#2.}\else#2\fi.}\kern 0pt}}
%\def\rightnote#1#2.{\vskip-\baselineskip\hbox to \hsize{\hfill
%    \tiny#1~\ifacro{\pdfnote#2.}\else#2\fi.}}
%\def\rightnote#1#2.{\penalty1000\discretionary{}{\hbox{}}{\kern 2em}\penalty1000\hfill
%    \hbox{\tiny#1~\ifacro{\pdfnote#2.}\else#2\fi.}}
\def\rightnote#1#2.{%
     \penalty1000\discretionary{}{\hbox{}}{\kern 3em}\penalty1000\hfill
     \hskip -4em plus 4em\hbox{\tiny #1~\ifacro{\pdfnote#2.}\else#2\fi.}}


%% how tags are printed
\def\X#1:#2\X{\ifmmode\gdef\XX{\null$\null}\else\gdef\XX{}\fi %$% section name
  \XX$\langle\,${\let\I=\ne#2\kern.5em
    \ifacro{\eightrm\pdfnote#1.}\else${}_{#1}$\fi}$\,\rangle$\XX}

% how to display hex numbers
\def\hex{\hbox{$^{\scriptstyle\#}$\tt\aftergroup}} % CWEB style

\long\def\leftmark#1#2{#1}
\long\def\subsectionmark#1#2{#2}
\long\def\rightmark#1#2{\if0#1\else\expandafter\subsectionmark\botmark\fi}

\def\lheader{\mainfont\strut
\thepageno\hfill\expandafter\leftmark\firstmark} % top line on left-hand pages

\def\rheader{\mainfont\strut
\expandafter\rightmark\firstmark\hfill\thepageno} % top line on right-hand pages

\let\page=\pagebody 
%\raggedbottom
\normalbottom
%\def\page{\box255 }\normalbottom % faster, but loses plain TeX footnotes
\def\normaloutput#1#2#3{\ifodd\pageno\hoffset=\pageshift\fi
 \shipout\vbox{
  \vbox to\fullpageheight{\iftitle\global\titlefalse
  \else\hbox{\vbox to \headheight{
    \hbox to \pagewidth{\ifodd\pageno #3\else#2\fi}
    \vskip 1pt\relax
    \nointerlineskip
     \hrule height .47pt
%    \hbox{\hrule}%fill\psfig{file=image/topline.eps}\hfil}%
    \vfil}}%
  \fi\nointerlineskip\hbox{\kern\marginwidth\vbox to \pageheight{#1}}}} % parameter #1 is the page itself
  \global\advance\pageno by1}

\def\nomarginoutput#1#2#3{%
 \ifodd\pageno\hoffset=\pageshift\fi
 \shipout\vbox to\fullpageheight{\nointerlineskip
  \iftitle\global\titlefalse
    \hbox{\vbox to \headheight{\vfil}}
  \else
    \hbox{\vbox to \headheight{\nointerlineskip
      \hbox to \pagewidth{\ifodd\pageno#3\else#2\fi}%
      \vskip 1 pt
      \nointerlineskip
      \hrule height .47pt
%    \hbox{\psfig{silent=,bbllx=0pt,bblly=0pt,bburx=368pt,bbury=2pt,file=image/topline.eps}\hfil}%
    \vfil}}%
  \fi\nointerlineskip #1 % parameter #1 is the page itself
%  \vss
%    \hbox to \pagewidth{\ifodd\pageno\else#2\fi}%
%    \nointerlineskip
%    \hbox{\psfig{file=image/topline.eps}\hfil}%
}% 
\global\advance\pageno by1}

%% switch to global nomargin
\let\normaloutput\nomarginoutput
\def\sectionbox#1{\hbox{#1}}
\marginwidth=0mm
\setpage

\def\inx{%
  \hsize=\pagewidth
  \def\page{\box255 } \normalbottom
  \output{\ifpagesaved\normaloutput{\box\sbox}\lheader\rheader\fi
    \global\setbox\sbox=\page \global\pagesavedtrue}
  \pagesavedfalse 
  \plainsection{Crossreference of Identifiers}% we are beginning the index
  \mark{{}{}}%
%\hbox{Mark empty empty}%
  \eject % eject the page-so-far and predecessors
  \setbox\sbox\vbox{\unvbox\sbox} % take it out of its box
  \vsize=\pageheight \advance\vsize by -\ht\sbox % the remaining height
  \hsize=.5\pagewidth \advance\hsize by -10pt
    % column width for the index (20pt between cols)
  \parfillskip 0pt plus .6\hsize % try to avoid almost empty lines
  \def\lr{L} % this tells whether the left or right column is next
  \output{\if L\lr\global\setbox\lbox=\page \gdef\lr{R}
    \else\nomarginoutput{\vbox to\pageheight{\box\sbox\vss
        \hbox to\pagewidth{\box\lbox\hfil\page}}}\lheader\rheader
    \global\vsize\pageheight\gdef\lr{L}\global\pagesavedfalse
  \mark{{Crossreference of Identifiers}{Crossreference of Identifiers}}%
\fi}
  \parfillskip 0pt plus 1fil
  \let\topsecno=\nullsec
  \message{Crossreference of Identifiers:}
  \parskip 0pt plus .5pt
  \outer\def\I##1, ##2.{\par\hangindent2em\noindent##1:\kern1em
    \ifacro\pdfnote##2.\else##2\fi.} % index entry
  \def\[##1]{$\underline{##1}$} % underlined index item
  \rm \rightskip0pt plus 2.5em \tolerance 10000 \let\*=\lapstar
  \hyphenpenalty 10000 \parindent0pt
  \small
  \readindex}
\def\fin{%
  \if L\lr\mark{{}{}}\fi
  \vfill\eject % complete the current column.
   \mark{{}{}}
  \if R\lr\null\vfill\eject\fi % if necessarry add a right column
  \setpage
  \def\page{\box255 } \normalbottom
  \output={\nomarginoutput\page\lheader\rheader}
}

\def\crosssections{
%  \plainsection{Crossreference of Sections}% this is done when we are ending the index
  \parindent 0pt
  \parfillskip 0pt plus 1fil
  \let\topsecno=\nullsec
  \message{Crossreference of Code:}
  \def\note##1##2.{\hfil\penalty-1\hfilneg\quad{\tiny##1~\ifacro{\pdfnote##2.}\else{##2}\fi.}}
  \def\Q{\note{Cited in section}} % crossref for mention of a section
  \def\Qs{\note{Cited in sections}} % crossref for mentions of a section
  \def\U{\note{Used in section}} % crossref for use of a section
  \def\Us{\note{Used in sections}} % crossref for uses of a section
  \def\I{\par\hangindent 2em}\let\*=*
  \def\X##1:##2\X{\ifmmode\gdef\XX{\null$\null}\else\gdef\XX{}\fi %$% section name
  \XX$\langle\,${\let\I=\ne##2}$\,\rangle$\XX\note{Defined in section}##1.}
  \readsections
}


%% delete the above definitions again so that they do not appear in the book.

\def\inx{  
\def\lr{L} % this tells whether the left or right column is next
}
%\def\fin{}

\makeatother







